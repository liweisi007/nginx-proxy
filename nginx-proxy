#!/bin/bash
# nginx-proxy 主脚本（生产自用版）

set -e

if [ "$(id -u)" != "0" ]; then
  echo "请使用 root 用户运行"
  exit 1
fi

if command -v apt >/dev/null 2>&1; then
  PM=apt
elif command -v yum >/dev/null 2>&1; then
  PM=yum
else
  echo "不支持的系统"
  exit 1
fi

install_nginx() {
  if ! command -v nginx >/dev/null 2>&1; then
    if [ "$PM" = "apt" ]; then
      apt update -y
      apt install -y nginx curl certbot python3-certbot-nginx
    else
      yum install -y epel-release
      yum install -y nginx curl certbot python3-certbot-nginx
    fi
  fi
  if ! pgrep nginx >/dev/null; then
    nginx
  fi
}

add_proxy() {
  read -p "监听端口: " PORT
  read -p "访问域名(_ 表示全部): " DOMAIN
  read -p "反代目标(http://127.0.0.1:8080): " TARGET

  CONF="/etc/nginx/conf.d/proxy_${PORT}.conf"

  cat > "$CONF" <<EOF
server {
    listen $PORT;
    server_name $DOMAIN;

    location / {
        proxy_pass $TARGET;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
    }
}
EOF

  nginx -t && nginx -s reload
}

remove_proxy() {
  ls /etc/nginx/conf.d/proxy_*.conf 2>/dev/null || echo "暂无配置"
  read -p "输入要删除的配置文件名: " CONF
  rm -f /etc/nginx/conf.d/$CONF
  nginx -t && nginx -s reload
}

enable_https() {
  read -p "请输入域名: " DOMAIN
  certbot --nginx -d "$DOMAIN"
}

uninstall_all() {
  read -p "输入 yes 确认卸载: " C
  [ "$C" != "yes" ] && exit 0
  pkill nginx || true
  rm -f /etc/nginx/conf.d/proxy_*.conf
  rm -f /usr/local/bin/nginx-go
  if [ "$PM" = "apt" ]; then
    apt remove -y nginx nginx-common nginx-core
    apt autoremove -y
  else
    yum remove -y nginx
  fi
}

case "$1" in
  add) install_nginx; add_proxy ;;
  del) remove_proxy ;;
  https) enable_https ;;
  uninstall) uninstall_all ;;
  *) install_nginx ;;
esac
