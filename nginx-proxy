#!/bin/bash
# nginx-proxy ä¸»è„šæœ¬ï¼ˆç”Ÿäº§è‡ªç”¨ç‰ˆï¼‰

set -e

if [ "$(id -u)" != "0" ]; then
  echo "è¯·ä½¿ç”¨ root ç”¨æˆ·è¿è¡Œ"
  exit 1
fi

if command -v apt >/dev/null 2>&1; then
  PM=apt
elif command -v yum >/dev/null 2>&1; then
  PM=yum
else
  echo "ä¸æ”¯æŒçš„ç³»ç»Ÿ"
  exit 1
fi

install_nginx() {
  if ! command -v nginx >/dev/null 2>&1; then
    if [ "$PM" = "apt" ]; then
      apt update -y
      apt install -y nginx curl certbot python3-certbot-nginx
    else
      yum install -y epel-release
      yum install -y nginx curl certbot python3-certbot-nginx
    fi
  fi
  if ! pgrep nginx >/dev/null; then
    nginx
  fi
}

add_proxy() {

  read -p "ç›‘å¬ç«¯å£: " PORT
  read -p "è®¿é—®åŸŸå(example.comï¼Œ_ è¡¨ç¤ºå…¨éƒ¨): " DOMAIN
  read -p "åä»£ç›®æ ‡åŸŸå(å¦‚ 127.0.0.1): " TARGET_HOST
  read -p "åä»£ç›®æ ‡ç«¯å£(é»˜è®¤è‡ªåŠ¨è¯†åˆ«): " TARGET_PORT

  # è‡ªåŠ¨è¯†åˆ«ç«¯å£ä¸åè®®
  if [ -z "$TARGET_PORT" ]; then
    TARGET_PORT=80
  fi

  if [ "$TARGET_PORT" = "443" ]; then
    TARGET_PROTO=https
  else
    TARGET_PROTO=http
  fi

  TARGET="${TARGET_PROTO}://${TARGET_HOST}:${TARGET_PORT}"

  if [[ "$DOMAIN" != "_" && "$DOMAIN" != http* ]]; then
    DOMAIN_HTTPS="https://${DOMAIN}"
  else
    DOMAIN_HTTPS="$DOMAIN"
  fi

  CONF="/etc/nginx/conf.d/proxy_${PORT}.conf"

  cat > "$CONF" <<EOF
server {
    listen $PORT;
    server_name $DOMAIN;

    location / {
        proxy_pass $TARGET;
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
    }
}
EOF

  nginx -t && nginx -s reload

  echo
  echo "âœ… åå‘ä»£ç†åˆ›å»ºæˆåŠŸ"
  echo "ğŸŒ è®¿é—®åœ°å€: $DOMAIN_HTTPS"
  echo "â¡ï¸  åä»£ç›®æ ‡: $TARGET"
}

EOF

  nginx -t && nginx -s reload

  echo
  echo "âœ… åå‘ä»£ç†åˆ›å»ºæˆåŠŸ"
  echo "ğŸŒ è®¿é—®åœ°å€: $DOMAIN_HTTPS"
  echo "â¡ï¸  åä»£ç›®æ ‡: $TARGET"
}

EOF

  nginx -t && nginx -s reload
}

remove_proxy() {
  ls /etc/nginx/conf.d/proxy_*.conf 2>/dev/null || echo "æš‚æ— é…ç½®"
  read -p "è¾“å…¥è¦åˆ é™¤çš„é…ç½®æ–‡ä»¶å: " CONF
  rm -f /etc/nginx/conf.d/$CONF
  nginx -t && nginx -s reload
}

enable_https() {
  read -p "è¯·è¾“å…¥åŸŸå: " DOMAIN
  certbot --nginx -d "$DOMAIN"
}

uninstall_all() {
  read -p "è¾“å…¥ yes ç¡®è®¤å¸è½½: " C
  [ "$C" != "yes" ] && exit 0
  pkill nginx || true
  rm -f /etc/nginx/conf.d/proxy_*.conf
  rm -f /usr/local/bin/nginx-go
  if [ "$PM" = "apt" ]; then
    apt remove -y nginx nginx-common nginx-core
    apt autoremove -y
  else
    yum remove -y nginx
  fi
}

case "$1" in
  add) install_nginx; add_proxy ;;
  del) remove_proxy ;;
  https) enable_https ;;
  uninstall) uninstall_all ;;
  *) install_nginx ;;
esac
